name: CI Integration Test

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]

jobs:
  test-install:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-choice: [1, 2, 3] # 1=Java8, 2=Java17, 3=Java21
    
    services:
      mongo:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get Docker Bridge Gateway IP
      id: network
      run: |
        # Get the gateway IP of the default docker bridge so the container can talk to the host (where mongo runs)
        GATEWAY_IP=$(docker network inspect bridge --format='{{(index .IPAM.Config 0).Gateway}}')
        echo "GATEWAY_IP=$GATEWAY_IP" >> $GITHUB_ENV
        echo "Detected Docker Gateway: $GATEWAY_IP"

    - name: Run Install Script (Option ${{ matrix.java-choice }})
      run: |
        chmod +x install.sh
        
        # Prepare inputs:
        # 1. Java Version: ${{ matrix.java-choice }}
        # 2. Mongo URI: Using gateway IP to access service on host
        # 3. Expose Ports: n
        
        printf "${{ matrix.java-choice }}\nmongodb://${{ env.GATEWAY_IP }}:27017/obsidian_test\nn\n" | ./install.sh

    - name: Wait for Server to Start
      run: |
        echo "Waiting for backend to be ready..."
        # Initial wait
        sleep 10
        
        # Poll for up to 60 seconds
        for i in {1..12}; do
          if curl -s http://localhost:5000 > /dev/null; then
            echo "Server is up!"
            exit 0
          fi
          echo "Waiting..."
          sleep 5
        done
        
        echo "Server failed to start in time."
        docker logs obsidian-panel
        exit 1

    - name: Verify API Response
      run: |
        curl -v http://localhost:5000
